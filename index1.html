<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€ å…¨çƒä¿å‘½ç¬¦ - æœ€çµ‚å¯¦æˆ°ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #050505; }
        .tab-active { border-bottom: 4px solid #10b981; color: #10b981; font-weight: 900; }
        .card-gradient { background: linear-gradient(145deg, #111, #080808); border: 1px solid #333; transition: all 0.3s; position: relative; }
        .status-good { border-color: #10b981; box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
        .calc-input { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 6px 10px; color: #10b981; font-weight: bold; }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
        .gold-glow { text-shadow: 0 0 10px rgba(234, 179, 8, 0.8); color: #eab308; }
    </style>
</head>
<body class="text-slate-200 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 bg-gray-900 border-2 border-emerald-600/30 p-6 rounded-3xl shadow-2xl">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div>
                    <h1 class="text-3xl font-black text-emerald-500 italic">ğŸ€ å…¨çƒè²¡å¯Œå°èˆª</h1>
                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mt-1">å°ç¾å¯¦æˆ°æ•´åˆç‰ˆ | Protector K System</p>
                </div>
                
                <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 bg-black/40 p-4 rounded-2xl border border-gray-800">
                    <div>
                        <label class="text-[10px] font-black text-gray-500 block mb-1">ğŸ’° ç¸½æŠ•è³‡æœ¬é‡‘ (TWD/USD)</label>
                        <input type="number" id="total-capital" oninput="saveSettings()" class="calc-input w-full" placeholder="è¼¸å…¥ç¸½é‡‘é¡">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-gray-500 block mb-1">ğŸ¤– TG Bot Token</label>
                        <input type="password" id="tg-token" oninput="saveSettings()" class="calc-input w-full" placeholder="Token">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-gray-500 block mb-1">ğŸ†” TG Chat ID</label>
                        <input type="text" id="tg-id" oninput="saveSettings()" class="calc-input w-full" placeholder="Chat ID">
                    </div>
                </div>
            </div>
            <div class="mt-4 flex flex-col md:flex-row justify-between items-center gap-4">
                <p class="text-[10px] text-gray-500 italic">* ç³»çµ±å°‡è‡ªå‹•åˆ†é… 15% æœ¬é‡‘ä½œç‚ºå–®ç­†å»ºè­°è²·å…¥é‡ï¼Œåš´æ§é¢¨éšªã€‚</p>
                <button onclick="analyzeAll()" class="bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-black px-10 py-2 rounded-full transition-all uppercase tracking-widest shadow-lg">
                    åŒæ­¥å…¨çƒæ•¸æ“šæƒæ
                </button>
            </div>
        </header>

        <nav class="flex space-x-12 mb-8 border-b border-gray-800 font-bold">
            <button onclick="switchMarket('tw')" id="btn-tw" class="pb-4 tab-active">ğŸ‡¹ğŸ‡¼ å°è‚¡ç†±é–€ (20æª”)</button>
            <button onclick="switchMarket('us')" id="btn-us" class="pb-4 text-gray-500 hover:text-gray-300">ğŸ‡ºğŸ‡¸ ç¾è‚¡é ˜é ­ç¾Š (15æª”)</button>
        </nav>

        <div id="tw-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <p class="col-span-full text-center text-gray-600 py-10 blink font-bold uppercase">æ­£åœ¨è¨ˆç®—å°è‚¡ 240MA ç”Ÿå‘½ç·š...</p>
        </div>

        <div id="us-section" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <p class="col-span-full text-center text-gray-600 py-10 blink font-bold uppercase">æ­£åœ¨é€£ç·šç¾è‚¡ Stooq æ•¸æ“šç¯€é»...</p>
        </div>

        <footer class="mt-16 p-8 bg-emerald-950/10 border border-emerald-900/20 rounded-3xl text-center">
            <p class="text-emerald-500 font-black mb-1 italic text-sm">ğŸ’¡ ä¿å‘½å®ˆå‰‡ï¼šé«˜æ–¼å¹´ç·šä¸è¿½åƒ¹ï¼Œä½æ–¼å¹´ç·šåˆ†æ‰¹æ¥ã€‚</p>
            <p class="text-gray-700 text-[10px] font-bold uppercase tracking-widest">Global Wealth Guard v3.5 | Professional Edition</p>
        </footer>
    </div>

    <script>
        const twList = ["00878","00929","00919","0056","00940","0050","006208","00713","00915","00881","00935","00934","00936","00900","00679B","00687B","00937B","00720B","00751B","00637L"];
        const usList = ["VOO","QQQ","VTI","TSLA","NVDA","AAPL","MSFT","GOOGL","BRK.B","AMD","TSM","AVGO","LLY","META","AMZN"];
        
        let sentSignals = new Set();

        window.onload = () => {
            document.getElementById('total-capital').value = localStorage.getItem('global_cap') || 100000;
            document.getElementById('tg-token').value = localStorage.getItem('global_tk') || '';
            document.getElementById('tg-id').value = localStorage.getItem('global_id') || '';
            analyzeAll();
        };

        function saveSettings() {
            localStorage.setItem('global_cap', document.getElementById('total-capital').value);
            localStorage.setItem('global_tk', document.getElementById('tg-token').value);
            localStorage.setItem('global_id', document.getElementById('tg-id').value);
        }

        async function sendTG(msg) {
            const token = document.getElementById('tg-token').value;
            const id = document.getElementById('tg-id').value;
            if(!token || !id) return;
            const url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${id}&text=${encodeURIComponent(msg)}&parse_mode=HTML`;
            try { await fetch(url); } catch(e) {}
        }

        async function analyzeAll() {
            analyzeMarket('tw', twList, `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id={ID}&start_date=${new Date(Date.now()-365*86400000).toISOString().split('T')[0]}`, "ğŸ‡¹ğŸ‡¼", "TWD");
            analyzeMarket('us', usList, `https://stooq.com/q/d/l/?s={ID}.US&i=d`, "ğŸ‡ºğŸ‡¸", "USD");
        }

        async function analyzeMarket(type, list, urlTemplate, flag, currency) {
            const container = document.getElementById(`${type}-section`);
            let html = '';
            const capital = parseFloat(document.getElementById('total-capital').value) || 0;
            
            for(let id of list) {
                try {
                    let prices = [];
                    if(type === 'tw') {
                        const res = await fetch(urlTemplate.replace("{ID}", id));
                        const json = await res.json();
                        prices = json.data.map(d => d.close);
                    } else {
                        const res = await fetch(urlTemplate.replace("{ID}", id));
                        const text = await res.text();
                        prices = text.split('\n').slice(1).filter(r => r).map(r => parseFloat(r.split(',')[4]));
                    }
                    
                    if(prices.length > 0) {
                        html += processLogic(id, prices, flag, capital, currency);
                        container.innerHTML = html;
                    }
                } catch(e) { console.error(id + " fetch error"); }
            }
        }

        function processLogic(id, prices, flag, totalCapital, currency) {
            const current = prices[prices.length - 1];
            const ma240 = prices.reduce((a,b) => a + b) / prices.length;
            const rsi = calcRSI(prices.slice(-20));
            const isGolden = current < ma240 && rsi < 35;
            const suggestAmount = (totalCapital * 0.15).toFixed(0);

            if(isGolden && !sentSignals.has(id)) {
                sendTG(`<b>ğŸ’ ç™¼ç¾é»ƒé‡‘æ©Ÿæœƒ (${flag})</b>\n\næ¨™çš„ï¼š<b>${id}</b>\nç›®å‰åƒ¹æ ¼ï¼š$${current.toFixed(2)}\n\nğŸ’¡ å»ºè­°æŠ•å…¥é‡‘é¡ï¼š<b>${suggestAmount} ${currency}</b>\n\nç‹€æ…‹ï¼šè·Œç ´å¹´ç·š + ä½ä½éš\n<i>BY PROTECTOR K</i>`);
                sentSignals.add(id);
                setTimeout(() => sentSignals.delete(id), 86400000); 
            }

            return `
                <div class="card-gradient p-6 rounded-[2.5rem] border-2 ${isGolden ? 'status-good shadow-xl' : 'border-gray-800'}">
                    ${isGolden ? '<div class="absolute top-0 right-0 bg-emerald-500 text-black px-4 py-1 text-[8px] font-black blink italic tracking-widest uppercase">Golden Buy</div>' : ''}
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-2xl font-black text-white">${id}</h2>
                            <p class="text-[9px] text-gray-500 font-bold">${flag} å¸‚å ´é¾é ­</p>
                        </div>
                        <span class="text-2xl">${isGolden ? 'ğŸ¤©' : 'ğŸ˜'}</span>
                    </div>
                    <div class="bg-emerald-500/10 border border-emerald-500/20 p-4 rounded-2xl mb-6">
                        <p class="text-[8px] text-emerald-500 font-black mb-1 uppercase tracking-widest">å»ºè­°æŠ•å…¥é‡ (${currency})</p>
                        <p class="text-3xl font-black text-emerald-500 font-mono italic">$ ${suggestAmount}</p>
                    </div>
                    <div class="space-y-2 text-[10px] font-bold text-gray-500">
                        <div class="flex justify-between border-b border-gray-800/50 pb-1">
                            <span>ç•¶å‰å¸‚åƒ¹:</span><span class="text-white">$${current.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-800/50 pb-1">
                            <span>å¹´ç·šä½éš (240MA):</span><span class="${current < ma240 ? 'text-emerald-500' : 'text-gray-400'}">${current < ma240 ? 'ä¾¿å®œ' : 'æ­£å¸¸'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>RSI ç†±åº¦:</span><span class="${rsi < 35 ? 'text-emerald-500' : 'text-gray-400'}">${rsi.toFixed(1)}</span>
                        </div>
                    </div>
                </div>`;
        }

        function calcRSI(p) {
            let g=0, l=0;
            for(let i=p.length-14; i<p.length; i++) {
                let d=p[i]-p[i-1]; d>=0 ? g+=d : l-=d;
            }
            return l===0 ? 100 : 100-(100/(1+(g/14)/(l/14)));
        }

        function switchMarket(m) {
            document.getElementById('tw-section').classList.toggle('hidden', m!=='tw');
            document.getElementById('us-section').classList.toggle('hidden', m!=='us');
            document.getElementById('btn-tw').className = `pb-4 ${m==='tw'?'tab-active':'text-gray-500'}`;
            document.getElementById('btn-us').className = `pb-4 ${m==='us'?'tab-active':'text-gray-500'}`;
        }
    </script>
</body>
</html>
