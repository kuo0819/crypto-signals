<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€ å…¨çƒä¿å‘½ç¬¦ - æ¸…æ¥šè¨ºæ–·ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #050505; }
        .tab-active { border-bottom: 4px solid #10b981; color: #10b981; font-weight: 900; }
        .card-gradient { background: linear-gradient(145deg, #111, #080808); border: 1px solid #333; transition: all 0.3s; position: relative; }
        
        /* ç‹€æ…‹ç‡ˆè™Ÿæ¨£å¼ */
        .status-danger { border-color: #ef4444; background: linear-gradient(145deg, #1a0505, #080808); }
        .status-success { border-color: #10b981; box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); background: linear-gradient(145deg, #051a10, #080808); }
        .status-normal { border-color: #444; }

        .calc-input { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 6px 10px; color: #10b981; font-weight: bold; }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
    </style>
</head>
<body class="text-slate-200 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 bg-gray-900 border-2 border-emerald-600/30 p-6 rounded-3xl shadow-2xl">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-1">
                    <h1 class="text-3xl font-black text-emerald-500 italic">ğŸ€ å…¨çƒè²¡å¯Œè¨ºæ–·</h1>
                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mt-1">ç²¾ç¢ºè²·è³£é»è¨ºæ–· | Protector K</p>
                </div>
                
                <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-4 gap-4 bg-black/40 p-4 rounded-2xl border border-gray-800">
                    <div>
                        <label class="text-[10px] font-black text-gray-400 block mb-1">ğŸ‡¹ğŸ‡¼ å°è‚¡ç¸½æœ¬é‡‘ (TWD)</label>
                        <input type="number" id="cap-tw" oninput="saveSettings()" class="calc-input w-full" placeholder="500000">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-gray-400 block mb-1">ğŸ‡ºğŸ‡¸ ç¾è‚¡ç¸½æœ¬é‡‘ (USD)</label>
                        <input type="number" id="cap-us" oninput="saveSettings()" class="calc-input w-full" placeholder="10000">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-gray-500 block mb-1">ğŸ¤– Bot Token</label>
                        <input type="password" id="tg-token" oninput="saveSettings()" class="calc-input w-full">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-gray-500 block mb-1">ğŸ†” Chat ID</label>
                        <input type="text" id="tg-id" oninput="saveSettings()" class="calc-input w-full">
                    </div>
                </div>
            </div>
            <div class="mt-4 flex justify-between items-center">
                <div class="flex gap-4 text-[10px] font-bold uppercase">
                    <span class="text-red-500">â— åƒ¹æ ¼éé«˜</span>
                    <span class="text-emerald-500">â— è²·å…¥æ¨™æº–</span>
                    <span class="text-gray-500">â— è§€æœ›/å®šæœŸå®šé¡</span>
                </div>
                <button onclick="analyzeAll()" class="bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-black px-10 py-2 rounded-full shadow-lg transition-all">
                    åŸ·è¡Œå…¨å¸‚å ´è¨ºæ–·
                </button>
            </div>
        </header>

        <nav class="flex space-x-12 mb-8 border-b border-gray-800 font-bold">
            <button onclick="switchMarket('tw')" id="btn-tw" class="pb-4 tab-active">ğŸ‡¹ğŸ‡¼ å°è‚¡å³æ™‚è¨ºæ–·</button>
            <button onclick="switchMarket('us')" id="btn-us" class="pb-4 text-gray-500 hover:text-gray-300">ğŸ‡ºğŸ‡¸ ç¾è‚¡å³æ™‚è¨ºæ–·</button>
        </nav>

        <div id="tw-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        <div id="us-section" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    </div>

    <script>
        const twList = ["00878","00929","00919","0056","00940","0050","006208","00713","00915","00881","00935","00934","00936","00900","00679B","00687B","00937B","00720B","00751B","00637L"];
        const usList = ["VOO","QQQ","VTI","TSLA","NVDA","AAPL","MSFT","GOOGL","BRK.B","AMD","TSM","AVGO","LLY","META","AMZN"];
        let sentSignals = new Set();

        window.onload = () => {
            document.getElementById('cap-tw').value = localStorage.getItem('cap_tw') || 100000;
            document.getElementById('cap-us').value = localStorage.getItem('cap_us') || 5000;
            document.getElementById('tg-token').value = localStorage.getItem('glob_tk') || '';
            document.getElementById('tg-id').value = localStorage.getItem('glob_id') || '';
            analyzeAll();
        };

        function saveSettings() {
            localStorage.setItem('cap_tw', document.getElementById('cap-tw').value);
            localStorage.setItem('cap_us', document.getElementById('cap-us').value);
            localStorage.setItem('glob_tk', document.getElementById('tg-token').value);
            localStorage.setItem('glob_id', document.getElementById('tg-id').value);
        }

        async function analyzeAll() {
            const twCap = parseFloat(document.getElementById('cap-tw').value) || 0;
            const usCap = parseFloat(document.getElementById('cap-us').value) || 0;
            analyzeMarket('tw', twList, "ğŸ‡¹ğŸ‡¼", "TWD", twCap);
            analyzeMarket('us', usList, "ğŸ‡ºğŸ‡¸", "USD", usCap);
        }

        async function analyzeMarket(type, list, flag, currency, cap) {
            const container = document.getElementById(`${type}-section`);
            let html = '';
            for(let id of list) {
                try {
                    let prices = [];
                    const url = type === 'tw' ? `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=${new Date(Date.now()-365*86400000).toISOString().split('T')[0]}` : `https://stooq.com/q/d/l/?s=${id}.US&i=d`;
                    const res = await fetch(url);
                    if(type === 'tw') {
                        const json = await res.json();
                        prices = json.data.map(d => d.close);
                    } else {
                        const text = await res.text();
                        prices = text.split('\n').slice(1).filter(r => r).map(r => parseFloat(r.split(',')[4]));
                    }
                    if(prices.length > 0) {
                        html += processDiagnosis(id, prices, flag, cap, currency);
                        container.innerHTML = html;
                    }
                } catch(e) {}
            }
        }

        function processDiagnosis(id, prices, flag, cap, currency) {
            const current = prices[prices.length - 1];
            const ma240 = prices.reduce((a,b) => a + b) / prices.length;
            const rsi = calcRSI(prices.slice(-20));
            
            let statusLabel = "";
            let statusColor = "";
            let cardClass = "";
            let advice = "";
            let icon = "";

            if (rsi > 70) {
                statusLabel = "ğŸ”´ åƒ¹æ ¼éé«˜ï¼Œç¦è²·";
                statusColor = "text-red-500";
                cardClass = "status-danger";
                advice = "å¸‚å ´éç†±ï¼Œè¿½é«˜å¿…æ­»ï¼Œè«‹è€å¿ƒç­‰å¾…å›æª”ã€‚";
                icon = "ğŸ¥µ";
            } else if (current < ma240 && rsi < 35) {
                statusLabel = "ğŸŸ¢ å·²é”è²·å…¥æ¨™æº–";
                statusColor = "text-emerald-500";
                cardClass = "status-success";
                advice = "é”åˆ°å¹´ç·šä¸‹ç”œç”œåƒ¹ï¼Œå»ºè­°åŸ·è¡Œä¿å‘½åˆ†æ‰¹è²·å…¥ã€‚";
                icon = "ğŸ¤©";
            } else {
                statusLabel = "âšª è§€æœ› / å®šæœŸå®šé¡";
                statusColor = "text-gray-400";
                cardClass = "status-normal";
                advice = "ä½éšå°šå¯ï¼Œä¸é©åˆå¤§ç­†åŠ ç¢¼ï¼Œç¶­æŒåŸæœ‰ç¯€å¥ã€‚";
                icon = "ğŸ˜";
            }

            const suggest = (cap * 0.15).toFixed(0);

            return `
                <div class="card-gradient p-6 rounded-[2.5rem] border-2 ${cardClass}">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-2xl font-black text-white">${id}</h2>
                            <p class="text-[10px] font-black uppercase ${statusColor}">${statusLabel}</p>
                        </div>
                        <span class="text-2xl">${icon}</span>
                    </div>

                    <div class="bg-black/50 p-4 rounded-2xl mb-4 border border-white/5">
                        <p class="text-[10px] text-gray-500 font-bold mb-1 uppercase">ç›®å‰è¨ºæ–·å»ºè­°</p>
                        <p class="text-sm font-black text-white leading-relaxed">${advice}</p>
                    </div>

                    <div class="bg-emerald-500/10 p-4 rounded-2xl mb-4">
                        <p class="text-[8px] text-emerald-500 font-black mb-1 uppercase tracking-widest">è‹¥æ˜¯è²·å…¥æ¨™è™Ÿ å»ºè­°æŠ•å…¥é‡ (${currency})</p>
                        <p class="text-3xl font-black text-emerald-500 font-mono">$ ${suggest}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-2 text-[10px] font-bold text-gray-500">
                        <div class="bg-white/5 p-2 rounded-lg text-center">
                            <p>å¸‚åƒ¹</p><p class="text-white text-sm">$${current.toFixed(2)}</p>
                        </div>
                        <div class="bg-white/5 p-2 rounded-lg text-center">
                            <p>RSI ç†±åº¦</p><p class="text-white text-sm">${rsi.toFixed(1)}</p>
                        </div>
                    </div>
                </div>`;
        }

        function calcRSI(p) {
            let g=0, l=0;
            for(let i=p.length-14; i<p.length; i++) {
                let d=p[i]-p[i-1]; d>=0 ? g+=d : l-=d;
            }
            return l===0 ? 100 : 100-(100/(1+(g/14)/(l/14)));
        }

        function switchMarket(m) {
            document.getElementById('tw-section').classList.toggle('hidden', m!=='tw');
            document.getElementById('us-section').classList.toggle('hidden', m!=='us');
            document.getElementById('btn-tw').className = `pb-4 ${m==='tw'?'tab-active':'text-gray-500'}`;
            document.getElementById('btn-us').className = `pb-4 ${m==='us'?'tab-active':'text-gray-500'}`;
        }
    </script>
</body>
</html>
